{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Создание шаблона</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <!-- CSS Files -->
  <link id="pagestyle" href="{% static 'css/material-dashboard.css' %}" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
    <style>
        .word-button {
            display: flex;
            margin: 5px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            cursor: pointer;
            border-radius: 8px;
            text-align: center;
        }
        .word-button:hover {
            background-color: orange;
            border-color: orange;
            color: white;
        }
    </style>
</head>
<body class="g-sidenav-show  bg-gray-100">
<aside class="sidenav navbar navbar-vertical navbar-expand-xs border-radius-lg fixed-start ms-2  bg-white my-2" id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-dark opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand px-4 py-3 m-0" href="/">
        <img src="{% static 'img/small.png' %}" class="navbar-brand-img" width="26" height="26" alt="main_logo">
        <span class="ms-1 text-sm text-dark">RFTK</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0 mb-2">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'invoice_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Счет</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'utd_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">УПД</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'vat_invoice_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Счет-фактура</span>
          </a>
        </li>
<!--        <li class="nav-item">-->
<!--          <a class="nav-link text-dark" href="{% url 'packing-list' %}">-->
<!--            <i class="material-symbols-rounded opacity-5">receipt_long</i>-->
<!--            <span class="nav-link-text ms-1">Товарная накладная</span>-->
<!--          </a>-->
<!--        </li>-->
        <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'commercial_offer_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Коммерческое предложение</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'outlay_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Смета</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'ks_2_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">КС-2</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'ks_3_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">КС-3</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'act_service_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Акт оказания услуг</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'power_attorney_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Доверенность</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'sales_receipt_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Товарный чек</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'pko_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">ПКО</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'rko_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">РКО</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'reconciliation_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Акт сверки взаиморасчетов</span>
          </a>
        </li>
          <li class="nav-item">
          <a class="nav-link text-dark" href="{% url 'agreement_document' %}">
            <i class="material-symbols-rounded opacity-5">receipt_long</i>
            <span class="nav-link-text ms-1">Договор/Документ</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <h6 class="ps-4 ms-2 text-uppercase text-xs text-dark font-weight-bolder" style="color: #FA980B!important;">Account pages</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link active bg-gradient-dark text-white" href="{% url 'profile' %}">
            <i class="material-symbols-rounded opacity-5">person</i>
            <span class="nav-link-text ms-1">Профиль</span>
          </a>
        </li>
        <li class="nav-item">
          {% if user.is_authenticated %}
          <a class="nav-link text-dark" href="{% url 'logout' %}">
            <i class="material-symbols-rounded opacity-5">logout</i>
            <span class="nav-link-text ms-1">Выйти</span>
          </a>
          {% else %}
          <a class="nav-link text-dark" href="{% url 'login' %}">
            <i class="material-symbols-rounded opacity-5">login</i>
            <span class="nav-link-text ms-1">Войти</span>
          </a>
          {% endif %}
        </li>
      </ul>
    </div>
  </aside>
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-3 shadow-none border-radius-xl" id="navbarBlur" data-scroll="true">
      <div class="container-fluid py-1 px-3">

        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">

          </div>
          <ul class="navbar-nav d-flex align-items-center  justify-content-end">

            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>


          </ul>
        </div>
      </div>
    </nav>
      <div class="container-fluid py-2">
        <div class="row">
        <div class="col-12">
          <div class="card my-4">
        <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
        <div class="bg-gradient-dark shadow-dark border-radius-lg pt-4 pb-3">
          <h6 class="text-white text-capitalize ps-3">Создание шаблона</h6>
          </div>
          </div>
        <div class="card-body px-0 pb-2">
              <div class="card-body">
    <form method="post">
      {% csrf_token %}
      <div class="card mb-4 p-3">
        {{ form.title.label }}<br>
        {{ form.title }}<br><br>

        {{ form.content.label }}<br>
        {{ form.content }}<br>
      </div>
        <div class="container-fluid py-2">
          <h3 class="">Метки шаблона</h3>
          <p class="mb-5">Условное обозначение меток, которые можно использовать в документе</p>
        <div id="wordButtons">
          <div class="row">
            {% for label in labels %}
            <div class="form-group col-md-6">
            <span>{{ label.label_desc }}</span>
            <span class="word-button mb-4">{{ label.label_code }}</span>
              </div>
            {% endfor %}
            </div>
        </div>
        </div>

        <br>
        <button type="submit" class="btn btn-primary">Сохранить</button>
    </form>

                <form method="post" id="form-new-label">
                  {% csrf_token %}
                  <div class="card mb-4 p-3 mt-5">
                    <h3 class="mb-5">Создать новую метку</h3>
                    {{ form_2.label_code.label }}<br>
                    {{ form_2.label_code }}<br><br>

                    {{ form_2.label_desc.label }}<br>
                    {{ form_2.label_desc }}<br>
                    <button type="submit" class="btn btn-primary w-25" id="button-new-label">Сохранить</button>
                  </div>
                </form>
                </div>
          </div>
      </div>
        </div>
        </div>
      </div>

    <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
    <script>
        CKEDITOR.replace('editor');

        document.addEventListener('DOMContentLoaded', function () {
            const buttons = document.querySelectorAll('.word-button');
            buttons.forEach(button => {
                button.addEventListener('click', function () {
                    const word = this.textContent;
                    CKEDITOR.instances.editor.insertText(word + ' ');
                });
            });
        });
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('#form-new-label');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(form);
        const submitButton = document.getElementById('button-new-label');
        const originalButtonText = submitButton.textContent;

        submitButton.disabled = true;
        submitButton.textContent = 'Сохранение...';

        fetch('http://103.74.95.216/add_labels/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('Метка успешно создана!');
                form.reset();

                const newLabelHtml = `
                    <div class="form-group col-md-6">
                        <span>${data.label.label_desc}</span>
                        <span class="word-button mb-4">${data.label.label_code}</span>
                    </div>
                `;

                const wordButtons = document.getElementById('wordButtons');
                const row = wordButtons.querySelector('.row');

                row.insertAdjacentHTML('beforeend', newLabelHtml);

            } else {
                // Ошибки валидации
                if (data.errors) {
                    let errorMessage = 'Ошибки при заполнении формы:\n';
                    for (const field in data.errors) {
                        errorMessage += `- ${data.errors[field].join(', ')}\n`;
                    }
                    alert(errorMessage);
                } else {
                    alert('Произошла ошибка при создании метки');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при отправке формы');
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
        });
    });
});
    </script>
</body>
</html>
